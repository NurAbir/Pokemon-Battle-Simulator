<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Pokémon Battle Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 50%, #7EC8E3 100%);
        }
    </style>
</head>
<body class="min-h-screen p-8">
    <!-- Header -->
    <div class="flex justify-end gap-4 mb-6">
        <button onclick="goHome()" class="px-6 py-2 bg-white rounded-lg shadow hover:shadow-md transition-shadow font-semibold">
            Home
        </button>
        <button onclick="logout()" class="px-6 py-2 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition-colors font-semibold">
            Logout
        </button>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column - Profile Info -->
        <div class="space-y-6">
            <!-- Profile Card -->
            <div class="bg-white/80 backdrop-blur rounded-2xl shadow-xl p-6">
                <div class="relative w-48 h-48 mx-auto mb-4 group">
                    <div id="avatarContainer" class="w-full h-full rounded-2xl overflow-hidden bg-gray-200 border-4 border-white shadow-lg">
                        <!-- Avatar will be loaded here -->
                    </div>
                    <label class="absolute bottom-2 right-2 bg-blue-500 text-white p-3 rounded-full cursor-pointer hover:bg-blue-600 transition-colors shadow-lg group-hover:scale-110 transform duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                        <input type="file" id="avatarInput" class="hidden" accept="image/*" onchange="uploadAvatar()">
                    </label>
                </div>

                <!-- Username -->
                <div class="text-center mb-4">
                    <div id="usernameDisplay" class="flex items-center justify-center gap-2">
                        <h2 id="username" class="text-2xl font-bold text-gray-800"></h2>
                        <button onclick="editUsername()" class="text-gray-500 hover:text-blue-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="usernameEdit" class="hidden flex items-center justify-center gap-2">
                        <input type="text" id="usernameInput" class="text-2xl font-bold text-center border-b-2 border-blue-500 focus:outline-none px-2" maxlength="20">
                        <button onclick="saveUsername()" class="text-green-600 hover:text-green-700">✓</button>
                        <button onclick="cancelUsernameEdit()" class="text-red-600 hover:text-red-700">✕</button>
                    </div>
                    <p id="userId" class="text-sm text-gray-500 mt-1"></p>
                </div>

                <!-- Bio -->
                <div class="bg-gray-100 rounded-lg p-3">
                    <div id="bioDisplay">
                        <div class="flex items-start justify-between">
                            <p id="bio" class="text-gray-600 text-sm flex-1"></p>
                            <button onclick="editBio()" class="text-gray-500 hover:text-blue-600 transition-colors ml-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="bioEdit" class="hidden">
                        <textarea id="bioInput" class="w-full p-2 border-2 border-blue-500 rounded focus:outline-none resize-none" rows="3" maxlength="100"></textarea>
                        <div class="flex justify-end gap-2 mt-2">
                            <button onclick="saveBio()" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm">Save</button>
                            <button onclick="cancelBioEdit()" class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 text-sm">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ranked Elo -->
            <div class="bg-white/80 backdrop-blur rounded-2xl shadow-xl p-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Ranked Elo</h3>
                <p id="eloRanked" class="text-3xl font-bold text-red-600">Unranked</p>
            </div>

            <!-- Statistics -->
            <div class="bg-white/80 backdrop-blur rounded-2xl shadow-xl p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Statistics</h3>
                
                <div class="space-y-4">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">Normal Mode:</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">matches played</p>
                                <p id="normalMatches" class="text-3xl font-bold text-gray-800">0</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">win/loss ratio</p>
                                <p id="normalWinRate" class="text-3xl font-bold text-gray-800">0%</p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">Ranked Mode:</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">matches played</p>
                                <p id="rankedMatches" class="text-3xl font-bold text-gray-800">0</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">win/loss ratio</p>
                                <p id="rankedWinRate" class="text-3xl font-bold text-gray-800">N/A</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Middle Column - Your Party -->
        <div class="space-y-6">
            <div class="bg-white/80 backdrop-blur rounded-2xl shadow-xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Your Party</h3>
                    <button onclick="changeTeam()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold shadow">
                        Change
                    </button>
                </div>

                <div id="partyContainer" class="grid grid-cols-2 gap-4">
                    <!-- Party will be loaded here -->
                    <div class="col-span-2 text-center text-gray-500 py-8">Loading team...</div>
                </div>
            </div>
        </div>

        <!-- Right Column - History -->
        <div class="space-y-6">
            <div class="bg-white/80 backdrop-blur rounded-2xl shadow-xl p-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">History</h3>

                <div id="historyContainer" class="space-y-3">
                    <!-- History will be loaded here -->
                    <p class="text-center text-gray-500 py-8">Loading history...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        let token = localStorage.getItem('token');
        let userData = {};

        // Check if user is logged in
        if (!token) {
            alert('Please login first!');
            window.location.href = 'login.html';
        }

        // Load profile data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadProfile();
            loadStats();
            loadTeam();
            loadHistory();
        });

        async function loadProfile() {
            try {
                const response = await fetch(`${API_URL}/user/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Session expired. Please login again.');
                        localStorage.removeItem('token');
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error('Failed to load profile');
                }

                const result = await response.json();
                userData = result.data;

                // Update UI
                document.getElementById('username').textContent = userData.username;
                document.getElementById('userId').textContent = `ID: ${userData.userId.slice(-8)}`;
                document.getElementById('bio').textContent = userData.bio || 'No bio yet...';
                
                // Load avatar
                const avatarContainer = document.getElementById('avatarContainer');
                if (userData.avatar) {
                    avatarContainer.innerHTML = `<img src="${API_URL.replace('/api', '')}${userData.avatar}" alt="Profile" class="w-full h-full object-cover">`;
                } else {
                    avatarContainer.innerHTML = `<div class="w-full h-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-white text-6xl font-bold">${userData.username[0].toUpperCase()}</div>`;
                }

                // Update ELO
                document.getElementById('eloRanked').textContent = userData.eloRating === 1000 ? 'Unranked' : userData.eloRating;
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Failed to load profile: ' + error.message);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/user/stats`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load stats');

                const result = await response.json();
                const stats = result.data;

                document.getElementById('normalMatches').textContent = stats.normalMatches;
                document.getElementById('normalWinRate').textContent = `${Math.round(stats.normalWinRate)}%`;
                document.getElementById('rankedMatches').textContent = stats.rankedMatches;
                document.getElementById('rankedWinRate').textContent = stats.rankedWinRate;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadTeam() {
            try {
                const response = await fetch(`${API_URL}/team/my-team`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load team');

                const result = await response.json();
                const team = result.data;

                const partyContainer = document.getElementById('partyContainer');
                if (team && team.pokemon && team.pokemon.length > 0) {
                    partyContainer.innerHTML = team.pokemon.map(p => `
                        <div class="bg-gray-100 rounded-xl p-4 hover:bg-gray-200 transition-colors cursor-pointer border-2 border-transparent hover:border-blue-400">
                            <img src="${p.pokemon.sprite}" alt="${p.pokemon.name}" class="w-full h-32 object-contain">
                            <p class="text-center font-semibold text-gray-700 mt-2">${p.pokemon.name}</p>
                            <p class="text-center text-sm text-gray-500">Lvl ${p.level}</p>
                        </div>
                    `).join('');
                } else {
                    partyContainer.innerHTML = '<p class="col-span-2 text-center text-gray-500 py-8">No team selected. Click "Change" to build your team!</p>';
                }
            } catch (error) {
                console.error('Error loading team:', error);
                document.getElementById('partyContainer').innerHTML = '<p class="col-span-2 text-center text-gray-500 py-8">No team selected</p>';
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch(`${API_URL}/user/history?limit=4`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load history');

                const result = await response.json();
                const history = result.data;

                const historyContainer = document.getElementById('historyContainer');
                if (history && history.length > 0) {
                    historyContainer.innerHTML = history.map(match => `
                        <div class="rounded-xl p-4 ${match.result === 'Win' ? 'bg-green-100 border-2 border-green-300' : 'bg-red-100 border-2 border-red-300'}">
                            <h4 class="text-2xl font-bold mb-3 ${match.result === 'Win' ? 'text-green-700' : 'text-red-700'}">${match.result}</h4>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-12 h-12 rounded-full bg-white overflow-hidden border-2 border-gray-300">
                                        ${userData.avatar ? 
                                            `<img src="${API_URL.replace('/api', '')}${userData.avatar}" alt="${userData.username}" class="w-full h-full object-cover">` :
                                            `<div class="w-full h-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-white font-bold text-lg">${userData.username[0].toUpperCase()}</div>`
                                        }
                                    </div>
                                    <span class="font-semibold text-gray-700">${userData.username}</span>
                                </div>
                                <span class="text-2xl font-bold text-gray-700">vs</span>
                                <div class="flex items-center gap-2">
                                    <div class="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center text-white text-lg font-bold border-2 border-white">
                                        ${match.opponent.slice(0, 2).toUpperCase()}
                                    </div>
                                    <span class="font-semibold text-gray-700">${match.opponent.slice(0, 8)}...</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    historyContainer.innerHTML = '<p class="text-center text-gray-500 py-8">No battle history yet. Start battling!</p>';
                }
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('historyContainer').innerHTML = '<p class="text-center text-gray-500 py-8">No battle history yet</p>';
            }
        }

        // Upload avatar
        async function uploadAvatar() {
            const fileInput = document.getElementById('avatarInput');
            const file = fileInput.files[0];

            if (!file) return;

            if (file.size > 5242880) {
                alert('Image size must be less than 5MB');
                return;
            }

            const formData = new FormData();
            formData.append('avatar', file);

            try {
                const response = await fetch(`${API_URL}/user/avatar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (!response.ok) throw new Error('Failed to upload avatar');

                const result = await response.json();
                
                // Update avatar display
                userData.avatar = result.data.avatar;
                const avatarContainer = document.getElementById('avatarContainer');
                avatarContainer.innerHTML = `<img src="${API_URL.replace('/api', '')}${userData.avatar}" alt="Profile" class="w-full h-full object-cover">`;
                
                alert('Avatar uploaded successfully!');
            } catch (error) {
                console.error('Error uploading avatar:', error);
                alert('Failed to upload avatar: ' + error.message);
            }
        }

        // Edit username
        function editUsername() {
            document.getElementById('usernameDisplay').classList.add('hidden');
            document.getElementById('usernameEdit').classList.remove('hidden');
            document.getElementById('usernameInput').value = userData.username;
            document.getElementById('usernameInput').focus();
        }

        async function saveUsername() {
            const newUsername = document.getElementById('usernameInput').value.trim();
            
            if (!newUsername) {
                alert('Username cannot be empty');
                return;
            }

            if (newUsername === userData.username) {
                cancelUsernameEdit();
                return;
            }

            try {
                const response = await fetch(`${API_URL}/user/profile`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username: newUsername })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to update username');
                }

                const result = await response.json();
                userData = result.data;
                document.getElementById('username').textContent = userData.username;
                cancelUsernameEdit();
                alert('Username updated successfully!');
            } catch (error) {
                console.error('Error updating username:', error);
                alert(error.message);
            }
        }

        function cancelUsernameEdit() {
            document.getElementById('usernameDisplay').classList.remove('hidden');
            document.getElementById('usernameEdit').classList.add('hidden');
        }

        // Edit bio
        function editBio() {
            document.getElementById('bioDisplay').classList.add('hidden');
            document.getElementById('bioEdit').classList.remove('hidden');
            document.getElementById('bioInput').value = userData.bio || '';
            document.getElementById('bioInput').focus();
        }

        async function saveBio() {
            const newBio = document.getElementById('bioInput').value.trim();

            try {
                const response = await fetch(`${API_URL}/user/profile`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ bio: newBio })
                });

                if (!response.ok) throw new Error('Failed to update bio');

                const result = await response.json();
                userData = result.data;
                document.getElementById('bio').textContent = userData.bio || 'No bio yet...';
                cancelBioEdit();
                alert('Bio updated successfully!');
            } catch (error) {
                console.error('Error updating bio:', error);
                alert('Failed to update bio: ' + error.message);
            }
        }

        function cancelBioEdit() {
            document.getElementById('bioDisplay').classList.remove('hidden');
            document.getElementById('bioEdit').classList.add('hidden');
        }

        function changeTeam() {
            alert('Team builder coming soon!');
            // window.location.href = 'team-builder.html';
        }

        function goHome() {
            window.location.href = 'index.html';
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>